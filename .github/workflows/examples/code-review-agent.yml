# Example: Code Review Agent
# This workflow runs an AI agent to review pull requests
#
# Copy this file to your repository's .github/workflows/ directory
# Required secrets:
#   - ANTHROPIC_API_KEY: Your Anthropic API key
#   - NATS_URL: (Optional) NATS server URL for Loom coordination

name: Code Review Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Prevent concurrent runs on the same PR
concurrency:
  group: code-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# IMPORTANT: Restrict who can trigger this workflow
# Only runs on PRs from collaborators, not from forks
# This prevents unauthorized API usage

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    # Security: Only run for non-fork PRs from trusted authors
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      (
        github.event.pull_request.author_association == 'OWNER' ||
        github.event.pull_request.author_association == 'MEMBER' ||
        github.event.pull_request.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/mdlopresti/loom-tools:claude-node20-full

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr.diff
          echo "diff_size=$(wc -l < /tmp/pr.diff)" >> $GITHUB_OUTPUT

      - name: Review PR
        if: steps.diff.outputs.diff_size > 0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NATS_URL: ${{ secrets.NATS_URL }}
          LOOM_PROJECT_ID: ${{ github.repository }}
          LOOM_AGENT_ID: code-reviewer-${{ github.run_id }}
        run: |
          # Start Warp in background if NATS_URL is configured
          if [ -n "$NATS_URL" ]; then
            warp &
            sleep 2
          fi

          # Run the code review
          claude --print --dangerously-skip-permissions \
            "Review this pull request. Focus on:
            1. Code quality and best practices
            2. Potential bugs or security issues
            3. Performance concerns
            4. Suggestions for improvement

            PR Title: ${{ github.event.pull_request.title }}
            PR Description: ${{ github.event.pull_request.body }}

            The diff is in /tmp/pr.diff. Read it and provide a constructive review.
            Format your response as a GitHub PR comment with markdown." \
            > /tmp/review.md

      - name: Post review comment
        if: steps.diff.outputs.diff_size > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## AI Code Review\n\n${review}\n\n---\n*Powered by [Loom Tools](https://github.com/mdlopresti/loom-tools)*`
            });
