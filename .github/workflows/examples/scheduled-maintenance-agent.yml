# Example: Scheduled Maintenance Agent
# This workflow runs an AI agent on a schedule to perform maintenance tasks
#
# Copy this file to your repository's .github/workflows/ directory
# Required secrets:
#   - ANTHROPIC_API_KEY: Your Anthropic API key
#
# SECURITY: Scheduled workflows only run on the default branch and cannot be
# triggered by external users. This is inherently safe.

name: Scheduled Maintenance Agent

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      task:
        description: 'Specific maintenance task (optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/mdlopresti/loom-tools:claude-node20-full

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config --global user.name "Loom Agent"
          git config --global user.email "loom-agent@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Run maintenance analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          TASK="${{ inputs.task }}"
          if [ -z "$TASK" ]; then
            TASK="Perform a weekly maintenance check on this repository:
            1. Check for outdated dependencies in package.json (if exists)
            2. Look for TODO/FIXME comments that should become issues
            3. Identify any obvious code quality improvements
            4. Check for potential security issues

            Output a JSON report with this structure:
            {
              \"dependency_updates\": [{\"package\": \"name\", \"current\": \"1.0.0\", \"latest\": \"2.0.0\"}],
              \"todos_found\": [{\"file\": \"path\", \"line\": 1, \"text\": \"TODO text\"}],
              \"suggestions\": [\"suggestion 1\", \"suggestion 2\"],
              \"security_notes\": [\"note 1\"]
            }"
          fi

          claude --print --dangerously-skip-permissions "$TASK" > /tmp/report.json

      - name: Create maintenance issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report;

            try {
              const content = fs.readFileSync('/tmp/report.json', 'utf8');
              // Try to extract JSON
              const jsonMatch = content.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                report = JSON.parse(jsonMatch[0]);
              } else {
                // If no JSON, use the raw output
                report = { raw_output: content };
              }
            } catch (e) {
              console.log('Could not parse report as JSON, using raw output');
              report = { raw_output: fs.readFileSync('/tmp/report.json', 'utf8') };
            }

            // Build the issue body
            let body = `## Weekly Maintenance Report\n\n`;
            body += `*Generated: ${new Date().toISOString()}*\n\n`;

            if (report.raw_output) {
              body += report.raw_output;
            } else {
              if (report.dependency_updates?.length > 0) {
                body += `### Dependency Updates\n\n`;
                body += `| Package | Current | Latest |\n|---------|---------|--------|\n`;
                for (const dep of report.dependency_updates) {
                  body += `| ${dep.package} | ${dep.current} | ${dep.latest} |\n`;
                }
                body += `\n`;
              }

              if (report.todos_found?.length > 0) {
                body += `### TODOs Found\n\n`;
                for (const todo of report.todos_found.slice(0, 10)) {
                  body += `- \`${todo.file}:${todo.line}\`: ${todo.text}\n`;
                }
                if (report.todos_found.length > 10) {
                  body += `- ... and ${report.todos_found.length - 10} more\n`;
                }
                body += `\n`;
              }

              if (report.suggestions?.length > 0) {
                body += `### Suggestions\n\n`;
                for (const suggestion of report.suggestions) {
                  body += `- ${suggestion}\n`;
                }
                body += `\n`;
              }

              if (report.security_notes?.length > 0) {
                body += `### Security Notes\n\n`;
                for (const note of report.security_notes) {
                  body += `- ${note}\n`;
                }
                body += `\n`;
              }
            }

            body += `\n---\n*Generated by [Loom Tools](https://github.com/mdlopresti/loom-tools)*`;

            // Check if there's anything to report
            const hasContent = report.raw_output ||
              report.dependency_updates?.length > 0 ||
              report.todos_found?.length > 0 ||
              report.suggestions?.length > 0 ||
              report.security_notes?.length > 0;

            if (hasContent) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Weekly Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['maintenance', 'automated']
              });
            }
